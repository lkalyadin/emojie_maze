<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Emoji Maze</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">

</head>
<body>
    <div id="loading-screen" class="screen active">
        <div class="loader-container">
            <div class="loader"></div>
            <div class="loader-inner">🎮</div>
        </div>
    </div>
    <div id="main-menu-screen" class="screen">
        <div class="background-emojis"></div>
        <div id="total-stars-counter"><div class="stars-display">⭐ 0</div></div>
        <div class="main-menu-container">
            <button id="play-button" class="menu-button nav-item" data-nav-index="0"><span class="play-icon">▶️</span></button>
            <div class="sub-menu-container">
                 <button id="themes-button" class="menu-button nav-item" data-nav-index="1"><span class="card-icon">🎨</span></button>
                 <button id="settings-button" class="menu-button nav-item" data-nav-index="2"><span class="card-icon">⚙️</span></button>
                 <button id="sound-toggle-button" class="menu-button nav-item" data-nav-index="3"><span class="card-icon">🔊</span></button>
            </div>
        </div>
        <button id="about-button" class="nav-item" data-nav-index="4">🧾</button>
    </div>
    <div id="game-mode-screen" class="screen">
        <div class="background-emojis"></div>
        <div class="sub-screen-top-bar">
            <button class="game-screen-icon-button back-button nav-item" data-target-screen="main-menu-screen" data-nav-index="0">🏠</button>
            <div class="stars-clone stars-display">⭐ 0</div>
        </div>
        <div class="menu-panel">
            <button id="mode-classic" class="mode-card nav-item" data-nav-index="1" data-mode="classic"><span class="card-icon">🗺️</span> <span data-lang="classic"></span><div class="mode-percentage">0%</div></button>
            <button id="mode-flashlight" class="mode-card nav-item" data-nav-index="2" data-mode="flashlight"><span class="card-icon">🔦</span> <span data-lang="flashlight"></span><div class="mode-percentage">0%</div></button>
            <button id="mode-ghost" class="mode-card nav-item" data-nav-index="3" data-mode="ghost"><span class="card-icon">👻</span> <span data-lang="ghost"></span><div class="mode-percentage">0%</div></button>
            <button id="mode-timer" class="mode-card nav-item" data-nav-index="4" data-mode="timer"><span class="card-icon">⏰</span> <span data-lang="timer"></span><div class="mode-percentage">0%</div></button>          
            <button id="mode-all-in-one" class="mode-card nav-item" data-nav-index="5" data-mode="all-in-one"><span class="card-icon">🗺️🔦👻⏰</span> <span data-lang="all_in_one"></span><div class="mode-percentage">0%</div></button>
            <button id="mode-minotaur" class="mode-card nav-item" data-nav-index="6" data-mode="minotaur"><span class="card-icon">🐂</span> <span data-lang="minotaur"></span><div class="mode-percentage">0%</div></button>
            <button id="mode-random" class="mode-card nav-item" data-nav-index="7" data-mode="random"><span class="card-icon">🎲</span> <span data-lang="random_mode"></span></button>
        </div>
    </div>
    <div id="level-selection-screen" class="screen">
        <div class="background-emojis"></div>
        <div class="sub-screen-top-bar">
            <button class="game-screen-icon-button back-button nav-item" data-target-screen="game-mode-screen" data-nav-index="0">⬅️</button>
            <div id="total-stars-counter-levels" class="stars-clone stars-display">⭐ 0</div>
        </div>
        <div class="menu-panel"><div id="level-selection-grid"></div></div>
    </div>
    <div id="settings-screen" class="screen">
        <div class="background-emojis"></div>
        <div class="sub-screen-top-bar">
            <button class="game-screen-icon-button back-button nav-item" data-target-screen="main-menu-screen" data-nav-index="0">🏠</button>
            <div class="stars-clone stars-display">⭐ 0</div>
        </div>
        <div class="menu-panel">
            <button id="dpad-toggle-button" class="menu-button nav-item" data-nav-index="1" style="justify-content:flex-start"><span class="card-icon">🕹️</span><span style="margin-left:12px"> D-pad</span><span class="dpad-status"></span></button>
            <button id="theme-toggle-button" class="menu-button nav-item" data-nav-index="2" style="justify-content:flex-start"><span class="card-icon"></span><span style="margin-left:12px" data-lang="color_theme"></span></button>
            <button id="language-button" class="menu-button nav-item" data-nav-index="3" style="justify-content:flex-start"><span class="card-icon">🌐</span><span class="lang-text" style="margin-left:12px"></span></button>
            <button id="reset-progress-button" class="menu-button nav-item" data-nav-index="4" style="background-color:var(--primary-pink);justify-content:flex-start"><span class="card-icon">🗑️</span><span style="margin-left:12px" data-lang="reset_progress"></span></button>
        </div>
    </div>
    <div id="themes-screen" class="screen">
        <div class="background-emojis"></div>
        <div class="sub-screen-top-bar">
             <button class="game-screen-icon-button back-button nav-item" data-target-screen="main-menu-screen" data-nav-index="0">🏠</button>
             <div class="stars-clone stars-display">⭐ 0</div>
        </div>
        <div class="menu-panel">
             <button id="random-theme-button" class="menu-button nav-item" data-nav-index="1" data-theme-key="random" tabindex="0"><span data-lang="random_theme"></span></button>
        </div>
    </div>
    <div id="game-screen" class="screen">
        <div class="background-emojis"></div>
        <div id="game-top-ui">
             <div class="top-left-buttons"><div class="game-button-panel"><button id="return-menu-button" class="game-screen-icon-button">🏠</button><button id="restart-game-button" class="game-screen-icon-button">🔄</button><button id="hint-button" class="game-screen-icon-button">💡</button></div></div>
             <div id="timer-container"><div id="timer-display"></div></div>
             <div class="top-right-ui"><div id="decor-counter"></div></div>
        </div>
        <div id="game-area-wrapper"><div id="maze-wrapper"><div id="maze-container"><canvas id="maze-canvas"></canvas></div></div></div>
        <div id="dpad-container"><button id="dpad-left" class="dpad-btn">⬅️</button><button id="dpad-right" class="dpad-btn">➡️</button><button id="dpad-down" class="dpad-btn">⬇️</button><button id="dpad-up" class="dpad-btn">⬆️</button></div>
    </div>
    <div id="victory-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="animation-container"></div>
            <h1 class="modal-title">🎉</h1>
            <div id="star-rating-container"></div>
            <div class="modal-buttons"><button id="menu-button-victory" class="menu-button emoji-button modal-button" data-modal-nav-index="0">🏠</button><button id="next-level-button" class="menu-button emoji-button modal-button" data-modal-nav-index="1">▶️</button><button id="retry-level-button-victory" class="menu-button emoji-button modal-button" data-modal-nav-index="2">🔄</button></div>
        </div>
    </div>
    <div id="minotaur-victory-modal" class="modal-overlay">
        <div class="minotaur-victory-content">
            <div id="minotaur-victory-bg">🏖️</div>
            <div id="minotaur-victory-player"></div>
            <div id="minotaur-victory-drink">🍹</div>
            <div id="minotaur-victory-cake">🎂</div>
        </div>
    </div>
    <div id="confirm-exit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title" data-lang="confirm_exit_title"></h2><p class="modal-text" data-lang="confirm_exit_text"></p>
            <div class="modal-buttons"><button id="confirm-exit-no" class="menu-button emoji-button modal-button" data-modal-nav-index="0">❌</button><button id="confirm-exit-yes" class="menu-button emoji-button modal-button" data-modal-nav-index="1">✅</button></div>
        </div>
    </div>
    <div id="confirm-reset-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title" data-lang="confirm_reset_title"></h2><p class="modal-text" data-lang="confirm_reset_text"></p>
            <div class="modal-buttons"><button id="confirm-reset-no" class="menu-button emoji-button modal-button" data-modal-nav-index="0">❌</button><button id="confirm-reset-yes" class="menu-button emoji-button modal-button" data-modal-nav-index="1">✅</button></div>
        </div>
    </div>
    <div id="tv-back-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">🌌</h2>
            <div class="modal-buttons"><button id="tv-back-home" class="menu-button emoji-button modal-button" data-modal-nav-index="0">🏠</button><button id="tv-back-restart" class="menu-button emoji-button modal-button" data-modal-nav-index="1">🔄</button><button id="tv-back-hint" class="menu-button emoji-button modal-button" data-modal-nav-index="2">💡</button><button id="tv-back-cancel" class="menu-button emoji-button modal-button" data-modal-nav-index="3">❌</button></div>
        </div>
    </div>
    <div id="about-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title" data-lang="about_title"></h2><p class="modal-text" data-lang="about_text"></p>
            <div class="modal-buttons"><button id="about-modal-close" class="menu-button emoji-button modal-button" data-modal-nav-index="0">✅</button></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const config = {
            backgrounds:['/assets/images/abstract-design-element-pink-3595.png','/assets/images/abstract-design-element-blue-purple-3588.png','/assets/images/abstract-design-element-pink-3599.png','/assets/images/abstract-design-element-pink-orange-3585.png','/assets/images/abstract-design-element-purple-3557.png','/assets/images/abstract-design-element-purple-3560.png','/assets/images/abstract-design-element-purple-3569.png','/assets/images/abstract-design-element-purple-3570.png','/assets/images/abstract-design-element-shape-purple-3463.png','/assets/images/abstract-design-element-shape-yellow-3472.png','/assets/images/abstract-design-element-shape-yellow-3474.png','/assets/images/abstract-design-element-yellow-orange-3575.png','/assets/images/abstract-design-element-yellow-orange-3577.png','/assets/images/design-element-wave-blue-3689.png'],
            levels_portrait: [
                {h:8,w:4,bonuses:0,visibility:{h:2,w:2},timer:30,ghosts:1,ghostPatrol:{w:2,h:2}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:9,w:4,bonuses:0,visibility:{h:2,w:2},timer:30,ghosts:1,ghostPatrol:{w:2,h:2}, mazeAlgorithm: 'sidewinder'},
                {h:9,w:5,bonuses:0,visibility:{h:2,w:2},timer:30,ghosts:1,ghostPatrol:{w:2,h:2}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:10,w:5,bonuses:2,visibility:{h:3,w:3},timer:30,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:10,w:6,bonuses:2,visibility:{h:3,w:3},timer:30,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:11,w:6,bonuses:3,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:11,w:7,bonuses:3,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:12,w:7,bonuses:3,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:12,w:8,bonuses:4,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:13,w:8,bonuses:4,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:13,w:9,bonuses:4,visibility:{h:3,w:3},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:14,w:9,bonuses:5,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:14,w:10,bonuses:5,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:15,w:10,bonuses:5,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:15,w:11,bonuses:5,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:16,w:11,bonuses:6,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:16,w:12,bonuses:6,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:17,w:12,bonuses:6,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:17,w:13,bonuses:6,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:18,w:13,bonuses:6,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:18,w:14,bonuses:7,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:19,w:14,bonuses:7,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:19,w:15,bonuses:7,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:20,w:15,bonuses:7,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:20,w:16,bonuses:7,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:21,w:16,bonuses:8,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:21,w:17,bonuses:8,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:22,w:17,bonuses:8,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:22,w:18,bonuses:8,visibility:{h:5,w:5},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:23,w:19,bonuses:9,visibility:{h:6,w:6},timer:99,ghosts:3,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'}
            ],
            levels_landscape: [
                {h:4,w:8,bonuses:0,visibility:{h:2,w:2},timer:30,ghosts:1,ghostPatrol:{w:2,h:2}, mazeAlgorithm: 'recursiveBacktracker'},{h:4,w:9,bonuses:0,visibility:{h:2,w:2},timer:30,ghosts:1,ghostPatrol:{w:2,h:2}, mazeAlgorithm: 'sidewinder'},{h:5,w:9,bonuses:0,visibility:{h:2,w:2},timer:30,ghosts:1,ghostPatrol:{w:2,h:2}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:5,w:10,bonuses:2,visibility:{h:3,w:3},timer:30,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:6,w:10,bonuses:2,visibility:{h:3,w:3},timer:30,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:6,w:11,bonuses:3,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:7,w:11,bonuses:3,visibility:{h:3,w:3},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:7,w:12,bonuses:3,visibility:{h:4,w:4},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:8,w:12,bonuses:4,visibility:{h:4,w:4},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:8,w:13,bonuses:4,visibility:{h:4,w:4},timer:60,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:9,w:13,bonuses:4,visibility:{h:4,w:4},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:9,w:14,bonuses:5,visibility:{h:5,w:5},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:10,w:14,bonuses:5,visibility:{h:5,w:5},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:10,w:15,bonuses:5,visibility:{h:5,w:5},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:11,w:15,bonuses:5,visibility:{h:5,w:5},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:11,w:16,bonuses:6,visibility:{h:6,w:6},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:12,w:16,bonuses:6,visibility:{h:6,w:6},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:12,w:17,bonuses:6,visibility:{h:6,w:6},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:13,w:17,bonuses:6,visibility:{h:6,w:6},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:13,w:18,bonuses:7,visibility:{h:7,w:7},timer:90,ghosts:1,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:14,w:18,bonuses:8,visibility:{h:6,w:6},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:14,w:19,bonuses:8,visibility:{h:6,w:6},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:15,w:19,bonuses:8,visibility:{h:6,w:6},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:15,w:20,bonuses:8,visibility:{h:6,w:6},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},
                {h:16,w:20,bonuses:7,visibility:{h:7,w:7},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:16,w:21,bonuses:8,visibility:{h:6,w:7},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:17,w:21,bonuses:8,visibility:{h:6,w:7},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},
                {h:17,w:22,bonuses:8,visibility:{h:6,w:7},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'},{h:18,w:22,bonuses:8,visibility:{h:6,w:7},timer:99,ghosts:2,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'recursiveBacktracker'},{h:19,w:23,bonuses:9,visibility:{h:7,w:7},timer:99,ghosts:3,ghostPatrol:{w:3,h:3}, mazeAlgorithm: 'sidewinder'}
            ],
            levels_minotaur_portrait: [
                {w: 9, h: 13, visibility: {w: 4, h: 4}, timer: 60, minotaurs: 1, bonuses: 2, mazeAlgorithm: 'prim'},
                {w: 11, h: 15, visibility: {w: 4, h: 4}, timer: 75, minotaurs: 1, bonuses: 3, mazeAlgorithm: 'prim'},
                {w: 13, h: 17, visibility: {w: 3, h: 3}, timer: 90, minotaurs: 2, bonuses: 4, mazeAlgorithm: 'prim'},
                {w: 15, h: 19, visibility: {w: 3, h: 3}, timer: 99, minotaurs: 2, bonuses: 5, mazeAlgorithm: 'prim'},
                {w: 17, h: 23, visibility: {w: 2, h: 2}, timer: 99, minotaurs: 3, bonuses: 6, mazeAlgorithm: 'prim'}
            ],
            levels_minotaur_landscape: [
                {w: 13, h: 9, visibility: {w: 4, h: 4}, timer: 60, minotaurs: 1, bonuses: 2, mazeAlgorithm: 'prim'},
                {w: 15, h: 11, visibility: {w: 4, h: 4}, timer: 75, minotaurs: 1, bonuses: 3, mazeAlgorithm: 'prim'},
                {w: 17, h: 13, visibility: {w: 3, h: 3}, timer: 90, minotaurs: 2, bonuses: 4, mazeAlgorithm: 'prim'},
                {w: 19, h: 15, visibility: {w: 3, h: 3}, timer: 99, minotaurs: 2, bonuses: 5, mazeAlgorithm: 'prim'},
                {w: 23, h: 17, visibility: {w: 9, h: 9}, timer: 99, minotaurs: 1, bonuses: 6, mazeAlgorithm: 'prim'}
            ],
            themes: {
                dog:{name:'Dog',player:'🐕',finish:'🏠',walls:['🏡','🌳','💧','🌿'],decor:['🐾'],gradient:['#FADDAA','#EDC967']},
                forest:{name:'Forest',player:'🐿️',finish:'🌰',walls:['🌲','🌳','🍄','🍁'],decor:['🌱'],gradient:['#D9EAD3','#B6D7A8']},
                jungle:{name:'Jungle',player:'🐒',finish:'🍌',walls:['?','','🌴','🌸'],decor:['🌺','🦋'],gradient:['#D4F0C4','#A0D8A0']},
                antarctica:{name:'Antarctica',player:'🐧',finish:'❤️',walls:['❄️','🧊'],decor:['🧊','❄️'],gradient:['#E6F3FB','#B0C4DE']},
                catsAndMice:{name:'Cats & Mice',player:'🐈',finish:'🐀',walls:['🌲','🏠','🌿','🐾'],decor:['🧶','🧀'],gradient:['#FFFACD','#F5DEB3']},
                snail:{name:'Snail',player:'🐌',finish:'🥬',walls:['🌲','🌸','🍄','💧'],decor:['🐞','🌼'],gradient:['#DFF0D8','#BDECB6']},
                football:{name:'Football',player:'⚽',finish:'🥅',walls:['📣','🏆','👟'],decor:['🏟️','🏅'],gradient:['#D9EAD3','#B6D7A8']},
                sea:{name:'Sea',player:'🐬',finish:'⭐',walls:['🌊','⛵','🏝️','🏖️'],decor:['🐠','🦀','🐚'],gradient:['#B2EBF2','#81D4FA']},
                desert:{name:'Desert',player:'🐪',finish:'🌴',walls:['🌵','🏜️','⛰️'],decor:['🌵'],gradient:['#FADDAA','#EDC967']},
                new_year:{name:'New Year',player:'🎁',finish:'🎄',walls:['❄️','⛄','🎅','🦌'],decor:['🌟','🔔'],gradient:['#A9B4C2','#E0F2F1']}
            },
            audio: {menu:'/assets/audio/light.ogg',game:['/assets/audio/kinderszenen.ogg','/assets/audio/mirlitons.ogg','/assets/audio/dogsandcats.ogg','/assets/audio/theskaterswaltz.ogg','/assets/audio/walkinganddancing.ogg'],victorySfx:['/assets/audio/sfx-piano-bar2.ogg','/assets/audio/sfx-sfx-strings7.ogg'],collectSfx:'/assets/audio/sfx-magic15.ogg',defeatSfx:'/assets/audio/sfx-pop2.ogg',timerWarningSfx:'/assets/audio/sfx-clock.ogg',timerDefeatSfx:'/assets/audio/sfx-cartoons19.ogg'},
            languageNames:{ru:'Русский',en:'English'},
            languages: {
                ru:{settings:'Настройки',themes:'Темы',random_theme:'Случайная тема',classic:'Классический',flashlight:'Фонарик',ghost:'Привидение',timer:'Таймер',minotaur: 'Минотавр', all_in_one:'Всё в одном',random_mode:'Случайный',menu:'Меню',retry:'Повторить',next_level:'Следующий',confirm_exit_title:'Выйти?',confirm_exit_text:'Прогресс уровня не будет сохранен.',select_mode:'Выберите режим',reset_progress:'Сбросить прогресс',confirm_reset_title:'Сбросить прогресс?',confirm_reset_text:'Все ваши звезды будут удалены. Это действие необратимо.',jungle:'Джунгли',antarctica:'Антарктика',catsAndMice:'Кошки-мышки',snail:'Улитка',football:'Футбол',sea:'Море',desert:'Пустыня',dog:'Собака',forest:'Лес',new_year: 'Новый год',color_theme:'Тема оформления',about_title:'О разработчике',about_text:'Emoji Maze - это увлекательная игра-головоломка, созданная для того, чтобы бросить вызов вашему пространственному мышлению и времени реакции. Игра разработана с использованием HTML5 Canvas, что обеспечивает плавную и отзывчивую графику как на настольных, так и на мобильных устройствах, а также на Android TV. Основное внимание уделяется простому и интуитивно понятному управлению, а также адаптивному дизайну. Цель игры - провести вашего персонажа-эмодзи через лабиринт, избегая привидений и собирая бонусы, чтобы достичь финиша. Наслаждайтесь игрой!'},
                en:{settings:'Settings',themes:'Themes',random_theme:'Random Theme',classic:'Classic',flashlight:'Flashlight',ghost:'Ghost',timer:'Timer',minotaur: 'Minotaur', all_in_one:'All in One',random_mode:'Random',menu:'Menu',retry:'Retry',next_level:'Next Level',confirm_exit_title:'Exit?',confirm_exit_text:'Level progress will be lost.',select_mode:'Select Mode',reset_progress:'Reset Progress',confirm_reset_title:'Reset progress?',confirm_reset_text:'All your stars will be deleted. This action is irreversible.',jungle:'Jungle',antarctica:'Antarctica',catsAndMice:'Cats & Mice',snail:'Snail',football:'Football',sea:'Sea',desert:'Desert',dog:'Dog',forest:'Forest',new_year: 'New Year',color_theme:'Color Theme',about_title:'About Developer',about_text:'Emoji Maze is an engaging puzzle game designed to challenge your spatial reasoning and reaction time. The game is developed using HTML5 Canvas, ensuring smooth and responsive graphics across desktop, mobile, and Android TV devices. The focus is on simple, intuitive controls and adaptive design. Your goal is to guide your emoji character through the maze, avoiding ghosts and collecting bonuses to reach the finish line. Enjoy the game!'}
            }
        };
        const state={currentScreen:'loading-screen',settings:{dpad:!1,sound:!0,language:'ru',colorTheme:'dark'},progress:{classic:{},flashlight:{},ghost:{},timer:{},minotaur:{},"all-in-one":{}},theme:'random',gameMode:'classic',currentLevel:0,dpadNavActive:!1,mazeWidth:4,mazeHeight:4,isGameActive:!1,isAnimating:!1,isMoving:!1,playerMoveDirection:null,isIntroAnimationActive:!1,playerIsDefeated:!1,isTimerDefeat:!1,defeatAnimation:{progress:0,bubbles:[]},gameTimer:{id:null,timeLeft:0,isPaused:!1},currentNavIndex:0,navigableItems:[],modalNavIndex:0,playerPos:{x:0,y:0},startPos:{x:0,y:0},finishPos:{x:0,y:0},ghosts:[],startGhosts:[],minotaurs:[],startMinotaurs:[],hint:{nextStep:null,visible:!1,timer:null},totalDecor:0,collectedDecor:0,wallColor:'#4B5563'};
        const audioManager={currentTrack:null,warningSfx:null,musicWasPlaying:!1,play(e,t=!1){if(!state.settings.sound)return;const a=e.split("/").pop();if(this.currentTrack&&this.currentTrack.src.endsWith(a)){this.currentTrack.paused&&this.currentTrack.play().catch(e=>{});return}this.stop(),this.currentTrack=new Audio(e),this.currentTrack.loop=t;const o=this.currentTrack.play();void 0!==o&&o.catch(()=>{const e=()=>{state.settings.sound&&this.currentTrack?.play().catch(e=>{}),window.removeEventListener("click",e),window.removeEventListener("keydown",e)};window.addEventListener("click",e,{once:!0}),window.addEventListener("keydown",e,{once:!0})})},stop(){this.currentTrack&&(this.currentTrack.pause(),this.currentTrack.onended=null,this.currentTrack.src="",this.currentTrack=null)},playSfx(e){if(!state.settings.sound)return;new Audio(e).play().catch(e=>{})},playWarningSfx(e,t=!0){state.settings.sound&&(this.stopWarningSfx(),this.warningSfx=new Audio(e),this.warningSfx.loop=t,this.warningSfx.play().catch(e=>{}))},stopWarningSfx(){this.warningSfx&&(this.warningSfx.pause(),this.warningSfx.src="",this.warningSfx=null)},playGameMusic(){if(state.gameMode==="minotaur"){this.play("https://lkalyadin.github.io/emojie_maze/assets/audio/aquarium.mp3",!0);return}this.stop();let e=[...config.audio.game];const t=()=>{if(!state.settings.sound||"game-screen"!==state.currentScreen)return;0===e.length&&(e=[...config.audio.game]);const a=e.splice(Math.floor(Math.random()*e.length),1)[0];this.play(a,!1),this.currentTrack&&(this.currentTrack.onended=t)};t()}};
        const dom = {
            loading: document.getElementById('loading-screen'),
            mainMenu: document.getElementById('main-menu-screen'),
            victoryModal: document.getElementById('victory-modal'),
            minotaurVictoryModal: document.getElementById('minotaur-victory-modal'),
            confirmExitModal: document.getElementById('confirm-exit-modal'),
            confirmResetModal: document.getElementById('confirm-reset-modal'),
            tvBackModal: document.getElementById('tv-back-modal'),
            aboutModal: document.getElementById('about-modal'),
            mazeCanvas: document.getElementById('maze-canvas'),
            totalStars: document.getElementById('total-stars-counter'),
            timerDisplay: document.getElementById('timer-display')
        };
        const mazeCtx = dom.mazeCanvas.getContext('2d');
        const loadedBackgroundImages = [];
        let mazeGrid, initialMazeGrid, currentTheme, cellSize, currentBgImage, animationFrameId, playerMoveInterval = null, ghostMoveIntervals = [], minotaurMoveIntervals = [], isStoppingGame = !1;
        let displayPos = {x:0,y:0}, targetPos = {x:0,y:0};
        const ANIMATION_SPEED = 0.4;
        function getActiveLevelsConfig(){
            const orientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
            if (state.gameMode === 'minotaur') {
                return orientation === 'landscape' ? config.levels_minotaur_landscape : config.levels_minotaur_portrait;
            }
            return orientation === 'landscape' ? config.levels_landscape : config.levels_portrait;
        }
        function saveSettings(){try{localStorage.setItem('emojiMazeSettings',JSON.stringify(state.settings))}catch(e){console.error("Failed to save settings:",e)}}
        function loadSettings(){try{const e=localStorage.getItem('emojiMazeSettings');e&&(state.settings={...state.settings,...JSON.parse(e)})}catch(e){console.error("Failed to load settings:",e)}}
        function saveProgress(){try{localStorage.setItem('emojiMazeProgress',JSON.stringify(state.progress))}catch(e){console.error("Failed to save progress:",e)}}
        function loadProgress(){try{const e=localStorage.getItem('emojiMazeProgress');if(e){const t=JSON.parse(e);
            state.progress = {
                classic: {}, flashlight: {}, ghost: {}, timer: {}, minotaur: {}, "all-in-one": {},
                ...t
            };
        }}catch(e){console.error("Failed to load progress:",e),state.progress={classic:{},flashlight:{},ghost:{},timer:{},minotaur:{},"all-in-one":{}}}}
        function updateTotalStarsCounter(){const e=Object.values(state.progress).flatMap(e=>Object.values(e)).reduce((e,t)=>e+t,0),t=`⭐ ${e}`;document.querySelector("#total-stars-counter .stars-display").innerHTML=t,document.querySelectorAll(".stars-clone").forEach(e=>e.innerHTML=t)}
        function resetProgress(){state.progress={classic:{},flashlight:{},ghost:{},timer:{},minotaur:{},"all-in-one":{}},saveProgress(),updateTotalStarsCounter(),updateModeCompletionPercentage(),"level-selection-screen"===state.currentScreen&&showLevelSelectionScreen(state.gameMode)}
        function stopPlayerMove(){playerMoveInterval&&(clearInterval(playerMoveInterval),playerMoveInterval=null),state.isMoving=!1,state.playerMoveDirection=null,state.playerIsDefeated||!state.isGameActive||checkWin()}
        function stopGhostAI(){ghostMoveIntervals.forEach(e=>clearInterval(e)),ghostMoveIntervals=[],state.ghosts.forEach(e=>{e.moveTimeout&&clearTimeout(e.moveTimeout)})}
        function stopMinotaurAI() {minotaurMoveIntervals.forEach(e => clearInterval(e)); minotaurMoveIntervals = []; state.minotaurs.forEach(m => { if (m.moveTimeout) clearTimeout(m.moveTimeout); });}
        function stopGame(){isStoppingGame||(isStoppingGame=!0,stopGameLoop(),stopPlayerMove(),stopGhostAI(),stopMinotaurAI(),clearInterval(state.gameTimer.id),state.gameTimer.id=null,state.gameTimer.isPaused=!1,audioManager.stopWarningSfx(),dom.timerDisplay.style.display="none",isStoppingGame=!1)}
        function switchScreen(e){stopGame();const t=document.getElementById(state.currentScreen);"game-screen"===state.currentScreen&&t&&t.querySelectorAll("#return-menu-button, #restart-game-button, #hint-button").forEach(e=>{e.removeAttribute("tabindex")}),t&&t.classList.remove("active");const a=document.getElementById(e);a&&(a.classList.add("active"),"game-screen"===e&&a.querySelectorAll("#return-menu-button, #restart-game-button, #hint-button").forEach(e=>{e.setAttribute("tabindex","-1")})),state.currentScreen=e,state.dpadNavActive=!1,state.isIntroAnimationActive=!1,dom.totalStars.style.display="main-menu-screen"===e?"flex":"none",updateEmojiBackground(),"game-mode-screen"===e&&updateModeCompletionPercentage(),document.getElementById("game-screen").classList.toggle("dpad-on",state.settings.dpad),setupNavigation();"game-screen"===e?audioManager.playGameMusic():audioManager.play(config.audio.menu,!0)}
        function goToMainMenu(){switchScreen("main-menu-screen")}
        function setupNavigation(){const e=document.getElementById(state.currentScreen);if(!e)return state.navigableItems=[],void(state.currentNavIndex=0);const t=Array.from(e.querySelectorAll(".nav-item, .back-button"));state.navigableItems=t.filter(e=>!e.classList.contains("disabled")).sort((e,t)=>{const a=parseInt(e.dataset.navIndex||"999"),o=parseInt(t.dataset.navIndex||"999");return a-o}),state.navigableItems.length>0?state.currentNavIndex=state.navigableItems.some(e=>0===parseInt(e.dataset.navIndex))&&state.navigableItems.length>1?1:0:state.currentNavIndex=0,updateNavSelection()}
        function ensureSelectedItemIsVisible(){if(!state.navigableItems.length)return;const e=state.navigableItems[state.currentNavIndex];if(e){const t={behavior:"smooth",block:"nearest",inline:"nearest"};"level-selection-screen"===state.currentScreen&&(t.block="center"),e.scrollIntoView(t)}}
        function updateNavSelection(){state.navigableItems.forEach((e,t)=>{const a=t===state.currentNavIndex&&state.dpadNavActive;e.classList.toggle("selected",a)}),state.dpadNavActive&&ensureSelectedItemIsVisible()}
        function handleModalNav(e,t){if(!state.dpadNavActive)return state.dpadNavActive=!0,state.modalNavIndex=0,updateModalNavSelection(t),void e.preventDefault();const a=Array.from(t.querySelectorAll(".modal-button"));if(!a.length)return;let o=!1;"ArrowRight"===e.key?(state.modalNavIndex=(state.modalNavIndex+1)%a.length,o=!0):"ArrowLeft"===e.key?(state.modalNavIndex=(state.modalNavIndex-1+a.length)%a.length,o=!0):"Enter"===e.key&&(a[state.modalNavIndex].click(),o=!0),o&&(updateModalNavSelection(t),e.preventDefault())}
        function updateModalNavSelection(e){const t=Array.from(e.querySelectorAll(".modal-button"));t.forEach((e,a)=>{e.classList.toggle("selected",a===state.modalNavIndex)})}
        function hideHint(){state.hint.visible=!1,state.hint.timer&&(clearTimeout(state.hint.timer),state.hint.timer=null),state.hint.nextStep=null}
        function handleGameScreenKeyDown(e){const t=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"],a=document.querySelector(".modal-overlay.visible");if(a)return void handleModalNav(e,a);if(state.hint.visible&&t.includes(e.key)){if(e.preventDefault(),hideHint(),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key))handleGameInput(e.key);return}if(state.playerIsDefeated)return;["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"].includes(e.key)?(e.preventDefault(),handleGameInput(e.key)):"Enter"===e.key&&(e.preventDefault(),showModal(dom.tvBackModal),state.isGameActive=!1)}
        function handleGlobalKeyDown(e){const t=document.querySelector(".modal-overlay.visible"),a=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"];if(t)return void handleModalNav(e,t);if("loading-screen"===state.currentScreen)return goToMainMenu(),void e.preventDefault();if("game-screen"===state.currentScreen)return void handleGameScreenKeyDown(e);if(!state.dpadNavActive&&a.includes(e.key)){if(state.dpadNavActive=!0,state.navigableItems.length>0){const e=state.navigableItems.some(e=>0===parseInt(e.dataset.navIndex));state.currentNavIndex=e&&state.navigableItems.length>1?1:0}updateNavSelection()}if(state.isMoving||state.playerIsDefeated||!state.navigableItems.length)return;let o=!1;const n="level-selection-screen"===state.currentScreen,s="main-menu-screen"===state.currentScreen,i=["game-mode-screen","settings-screen","themes-screen"].includes(state.currentScreen);let l=0;if(n){const e=document.getElementById("level-selection-grid");e&&(l=getComputedStyle(e).gridTemplateColumns.split(" ").length)}const r=state.currentNavIndex,d=state.navigableItems;switch(e.key){case"ArrowUp":n&&r>0?state.currentNavIndex=(r-l>=1?r-l:0):i&&r>0?state.currentNavIndex=Math.max(0,r-1):s&&r>0?state.currentNavIndex=0:state.currentNavIndex=Math.max(0,r-1),o=!0;break;case"ArrowDown":n&&r>0?r+l<d.length&&(state.currentNavIndex=r+l):n&&0===r&&d.length>1?state.currentNavIndex=1:i&&r<d.length-1?state.currentNavIndex++:s&&0===r&&d.length>1?state.currentNavIndex=1:r<d.length-1&&state.currentNavIndex++,o=!0;break;case"ArrowLeft":n&&r>0?((r-1)%l==0||1===l?state.currentNavIndex=0:state.currentNavIndex--):i&&r>0?state.currentNavIndex=0:s&&(4===r?state.currentNavIndex=3:r>0&&(state.currentNavIndex=Math.max(1,r-1))),o=!0;break;case"ArrowRight":n&&0===r&&d.length>1?state.currentNavIndex=1:n&&r>0?r%l==0&&l>1||r===d.length-1||r>=d.length-1||state.currentNavIndex++:i&&0===r&&d.length>1?state.currentNavIndex=1:s&&(3===r?state.currentNavIndex=4:r<3&&(state.currentNavIndex=Math.min(3,r+1))),o=!0;break;case"Enter":d[r]&&(d[r].click(),o=!0);break;case"Escape":const t=document.querySelector(`#${state.currentScreen} .back-button`);t&&(t.click(),o=!0)}o&&(e.preventDefault(),updateNavSelection())}
        function updateEmojiBackground(){const e=document.querySelector(`#${state.currentScreen} .background-emojis`);if(!e)return;let t=[];Object.values(config.themes).forEach(e=>{Array.isArray(e.walls)&&t.push(...e.walls.filter(e=>e&&""!==e.trim()))}),Object.values(config.themes).forEach(e=>{Array.isArray(e.decor)&&t.push(...e.decor.filter(e=>e&&""!==e.trim()))}),e.innerHTML="";for(let a=0;a<60;a++){const o=document.createElement("span");o.textContent=t.length>0?t[Math.floor(Math.random()*t.length)]:"✨",o.style.left=`${100*Math.random()}vw`,o.style.top=`${100*Math.random()}vh`,a<20?o.style.opacity="0.1":(o.classList.add("animated"),o.style.animationDelay=`${12*Math.random()}s`),e.appendChild(o)}}
        
        function generateRecursiveBacktrackerMaze(grid, startPos) {
            let stack = [grid[startPos.y][startPos.x]];
            grid[startPos.y][startPos.x].visited = true;

            while (stack.length > 0) {
                let current = stack.pop();
                let { x, y } = current;
                let neighbors = [];
                if (y > 0 && !grid[y - 1][x].visited) neighbors.push(grid[y - 1][x]);
                if (x < grid[0].length - 1 && !grid[y][x + 1].visited) neighbors.push(grid[y][x + 1]);
                if (y < grid.length - 1 && !grid[y + 1][x].visited) neighbors.push(grid[y + 1][x]);
                if (x > 0 && !grid[y][x - 1].visited) neighbors.push(grid[y][x - 1]);

                if (neighbors.length > 0) {
                    stack.push(current);
                    let next = neighbors[Math.floor(Math.random() * neighbors.length)];
                    if (next.y < current.y) { current.walls.top = false; next.walls.bottom = false; }
                    else if (next.x > current.x) { current.walls.right = false; next.walls.left = false; }
                    else if (next.y > current.y) { current.walls.bottom = false; next.walls.top = false; }
                    else if (next.x < current.x) { current.walls.left = false; next.walls.right = false; }
                    next.visited = true;
                    stack.push(next);
                }
            }
            return grid;
        }

        function generateSidewinderMaze(grid) {
            for (let y = 0; y < grid.length; y++) {
                let runStart = 0;
                for (let x = 0; x < grid[0].length; x++) {
                    const shouldCloseRun = (x + 1 === grid[0].length) || (y > 0 && Math.random() < 0.5);

                    if (shouldCloseRun) {
                        if (y > 0) {
                            const carveX = runStart + Math.floor(Math.random() * (x - runStart + 1));
                            grid[y][carveX].walls.top = false;
                            grid[y - 1][carveX].walls.bottom = false;
                        }
                        runStart = x + 1;
                    } else {
                        grid[y][x].walls.right = false;
                        grid[y][x + 1].walls.left = false;
                    }
                }
            }
            return grid;
        }
        
        function generatePrimMaze(grid) {
            const frontiers = [];
            const startX = Math.floor(Math.random() * grid[0].length);
            const startY = Math.floor(Math.random() * grid.length);
            grid[startY][startX].visited = true;

            const addFrontiers = (x, y) => {
                if (y > 0 && !grid[y - 1][x].visited) frontiers.push({ x, y: y - 1, from: { x, y } });
                if (y < grid.length - 1 && !grid[y + 1][x].visited) frontiers.push({ x, y: y + 1, from: { x, y } });
                if (x > 0 && !grid[y][x - 1].visited) frontiers.push({ x: x - 1, y, from: { x, y } });
                if (x < grid[0].length - 1 && !grid[y][x + 1].visited) frontiers.push({ x: x + 1, y, from: { x, y } });
            };

            addFrontiers(startX, startY);

            while (frontiers.length > 0) {
                const randIndex = Math.floor(Math.random() * frontiers.length);
                const { x, y, from } = frontiers.splice(randIndex, 1)[0];

                if (grid[y][x].visited) continue;
                grid[y][x].visited = true;

                if (x === from.x) {
                    if (y < from.y) { grid[from.y][from.x].walls.top = false; grid[y][x].walls.bottom = false; }
                    else { grid[from.y][from.x].walls.bottom = false; grid[y][x].walls.top = false; }
                } else {
                    if (x < from.x) { grid[from.y][from.x].walls.left = false; grid[y][x].walls.right = false; }
                    else { grid[from.y][from.x].walls.right = false; grid[y][x].walls.left = false; }
                }
                addFrontiers(x, y);
            }
            grid.forEach(row => row.forEach(cell => cell.visited = false));
            return grid;
        }

        function generateMaze(width, height, startPos, algorithm = 'recursiveBacktracker') {
            let grid = Array.from({ length: height }, (_, y) => Array.from({ length: width }, (_, x) => ({ x, y, walls: { top: true, right: true, bottom: true, left: true }, visited: false, decor: null })));
            
            switch(algorithm) {
                case 'sidewinder':
                    return generateSidewinderMaze(grid);
                case 'prim':
                     return generatePrimMaze(grid);
                case 'recursiveBacktracker':
                default:
                    return generateRecursiveBacktrackerMaze(grid, startPos);
            }
        }
        function findLongestPath(e,t){const a=[[t,0]],o=new Set([`${t.x},${t.y}`]);let n=0,s=t;for(;a.length>0;){const[t,i]=a.shift();if(i>n&&(n=i,s=t),!e[t.y][t.x].walls.top&&e[t.y-1]?.[t.x]){const n=`${t.x},${t.y-1}`;o.has(n)||(o.add(n),a.push([e[t.y-1][t.x],i+1]))}if(!e[t.y][t.x].walls.right&&e[t.y]?.[t.x+1]){const n=`${t.x+1},${t.y}`;o.has(n)||(o.add(n),a.push([e[t.y][t.x+1],i+1]))}if(!e[t.y][t.x].walls.bottom&&e[t.y+1]?.[t.x]){const n=`${t.x},${t.y+1}`;o.has(n)||(o.add(n),a.push([e[t.y+1][t.x],i+1]))}if(!e[t.y][t.x].walls.left&&e[t.y]?.[t.x-1]){const n=`${t.x-1},${t.y}`;o.has(n)||(o.add(n),a.push([e[t.y][t.x-1],i+1]))}}return s}
        function findSolutionPath(e,t,a){const o=[[t]],n=new Set([`${t.x},${t.y}`]);for(;o.length>0;){const t=o.shift(),s=t[t.length-1];if(s.x===a.x&&s.y===a.y)return t;const i=[],l=e[s.y][s.x];!l.walls.top&&e[s.y-1]?.[s.x]&&i.push(e[s.y-1][s.x]),!l.walls.right&&e[s.y]?.[s.x+1]&&i.push(e[s.y][s.x+1]),!l.walls.bottom&&e[s.y+1]?.[s.x]&&i.push(e[s.y+1][s.x]),!l.walls.left&&e[s.y]?.[s.x-1]&&i.push(e[s.y][s.x-1]);for(const e of i){const a=`${e.x},${e.y}`;n.has(a)||(n.add(a),o.push([...t,e]))}}return[]}
        function addDecorations(e,t,a,o){if(!currentTheme.decor||0===currentTheme.decor.length||!o)return void(state.totalDecor=0);const n=new Set([`${t.x},${t.y}`,`${a.x},${a.y}`]),s=[];for(let t=0;t<e.length;t++)for(let a=0;a<e[0].length;a++){n.has(`${a},${t}`)||s.push(e[t][a])}state.totalDecor=Math.min(o,s.length);for(let e=0;e<state.totalDecor;e++){if(0===s.length)break;const t=s.splice(Math.floor(Math.random()*s.length),1)[0];t&&(t.decor=currentTheme.decor[Math.floor(Math.random()*currentTheme.decor.length)])}}
        function drawTriangle(e,t,a,o,n,s,i=!1){e.save(),e.translate(t,a),e.rotate(n),e.beginPath(),e.moveTo(0,-o/1.5),e.lineTo(o/2,o/3),e.lineTo(-o/2,o/3),e.closePath(),i?(e.fillStyle=s,e.fill()):(e.strokeStyle=s,e.lineWidth=2,e.stroke()),e.restore()}
        function drawCircleOutline(e,t,a,o,n,s=2){e.save(),e.beginPath(),e.arc(t,a,o,0,2*Math.PI),e.strokeStyle=n,e.lineWidth=s,e.stroke(),e.restore()}
        function drawMoveIndicators(){if(state.isMoving)return;const{x:e,y:t}=state.playerPos,a=mazeGrid[t][e],o=.2*cellSize,n=Date.now(),s=Math.sin(.006*n)*(.05*cellSize);a.walls.top||drawTriangle(mazeCtx,e*cellSize+cellSize/2,(t-1)*cellSize+cellSize/2+s,o,0,"#696969"),a.walls.bottom||drawTriangle(mazeCtx,e*cellSize+cellSize/2,(t+1)*cellSize+cellSize/2-s,o,Math.PI,"#696969"),a.walls.left||drawTriangle(mazeCtx,(e-1)*cellSize+cellSize/2+s,t*cellSize+cellSize/2,o,-Math.PI/2,"#696969"),a.walls.right||drawTriangle(mazeCtx,(e+1)*cellSize+cellSize/2-s,t*cellSize+cellSize/2,o,Math.PI/2,"#696969")}
        function drawWavyLine(e,t,a,o,n){const s=o-t,i=n-a,l=Math.sqrt(s*s+i*i),r=Math.atan2(i,s);e.save(),e.translate(t,a),e.rotate(r),e.beginPath(),e.moveTo(0,0);for(let t=0;t<l;t++)e.lineTo(t,2*Math.sin(t/15*Math.PI));e.stroke(),e.restore()}
        function drawWalls(){mazeCtx.strokeStyle=state.wallColor,mazeCtx.lineWidth=Math.max(2,Math.min(6,Math.floor(.1*cellSize))),mazeCtx.lineCap="round",mazeCtx.beginPath(),mazeCtx.moveTo(0,0),mazeCtx.lineTo(state.mazeWidth*cellSize,0),mazeCtx.lineTo(state.mazeWidth*cellSize,state.mazeHeight*cellSize),mazeCtx.lineTo(0,state.mazeHeight*cellSize),mazeCtx.closePath(),mazeCtx.stroke();for(let e=0;e<state.mazeHeight;e++)for(let t=0;t<state.mazeWidth;t++){const a=mazeGrid[e][t],o=t*cellSize,n=e*cellSize;a.walls.bottom&&e<state.mazeHeight-1&&drawWavyLine(mazeCtx,o,n+cellSize,o+cellSize,n+cellSize),a.walls.right&&t<state.mazeWidth-1&&drawWavyLine(mazeCtx,o+cellSize,n,o+cellSize,n+cellSize)}}
        function drawDecor(){mazeCtx.textAlign="center",mazeCtx.textBaseline="middle";for(let e=0;e<state.mazeHeight;e++)for(let t=0;t<state.mazeWidth;t++){const a=mazeGrid[e][t];a.decor&&(mazeCtx.font=`bold ${.6*cellSize}px sans-serif`,mazeCtx.fillText(a.decor,t*cellSize+cellSize/2,e*cellSize+cellSize/2+.05*cellSize))}}
        function drawHintIndicator(){if(!state.hint.visible||!state.hint.nextStep)return;const e=state.hint.nextStep;let t=0;e.y<state.playerPos.y?t=0:e.y>state.playerPos.y?t=Math.PI:e.x<state.playerPos.x?t=-Math.PI/2:e.x>state.playerPos.x&&(t=Math.PI/2);const a=.3*cellSize,o=e.x*cellSize+cellSize/2,n=e.y*cellSize+cellSize/2,s=1+.1*Math.sin(.01*Date.now());drawTriangle(mazeCtx,o,n,a*s,t,"#53BF9D",!0)}
        function drawPlayer() {
            mazeCtx.save();
            const e = Math.floor(.7 * cellSize);
            mazeCtx.font = `bold ${e}px sans-serif`;
            let t = 0, a = 1, o = 1;
            if (state.isAnimating) {
                if (currentTheme.player === '⚽') {
                    t = (Date.now() / 150) * Math.PI; // Faster rotation
                } else if (currentTheme.player === '🐌') {
                    a = 1 + .1 * Math.sin(.015 * Date.now());
                    o = 1 - .1 * Math.sin(.015 * Date.now());
                } else {
                    t = .2 * Math.sin(.02 * Date.now());
                }
            }
            mazeCtx.translate(displayPos.x, displayPos.y);
            mazeCtx.rotate(t);
            mazeCtx.scale(a, o);
            mazeCtx.textAlign = "center";
            mazeCtx.textBaseline = "middle";
            mazeCtx.fillText(currentTheme.player, 0, 0 + .05 * cellSize);
            mazeCtx.restore();
        }
        function drawFinish(){mazeCtx.save();const e=Math.floor(.8*cellSize);mazeCtx.font=`bold ${e}px sans-serif`,mazeCtx.translate(state.finishPos.x*cellSize+cellSize/2,state.finishPos.y*cellSize+cellSize/2),mazeCtx.textAlign="center",mazeCtx.textBaseline="middle",mazeCtx.fillText(currentTheme.finish,0,0+.05*cellSize),mazeCtx.restore()}
        function drawGhosts(){mazeCtx.save();const e=Math.floor(.8*cellSize);mazeCtx.font=`bold ${e}px sans-serif`,mazeCtx.textAlign="center",mazeCtx.textBaseline="middle",state.ghosts.forEach(e=>{e.isIndicating&&e.nextMove&&drawCircleOutline(mazeCtx,e.nextMove.x*cellSize+cellSize/2,e.nextMove.y*cellSize+cellSize/2,.15*cellSize,"red",3);const t=Math.sin(.005*Date.now())*(.1*cellSize);mazeCtx.fillText("👻",e.displayPos.x,e.displayPos.y+t)}),mazeCtx.restore()}
        function drawMinotaurs(){mazeCtx.save();const e=Math.floor(.8*cellSize);mazeCtx.font=`bold ${e}px sans-serif`;mazeCtx.textAlign="center",mazeCtx.textBaseline="middle",state.minotaurs.forEach(minotaur=>{const t=Math.sin(.005*Date.now())*(.1*cellSize);mazeCtx.fillText("🐂",minotaur.displayPos.x,minotaur.displayPos.y+t)}),mazeCtx.restore()}
        function drawPlayerDefeatAnimation(){state.defeatAnimation.progress+=.02,state.defeatAnimation.progress>1&&(state.defeatAnimation.progress=1);const e=state.defeatAnimation.bubbles;mazeCtx.save(),mazeCtx.globalAlpha=1-state.defeatAnimation.progress,drawPlayer(),mazeCtx.restore(),mazeCtx.save(),mazeCtx.translate(displayPos.x,displayPos.y);for(const t of e)t.radius+=t.speed,t.opacity=1-t.radius/t.maxRadius,t.opacity<0&&(t.opacity=0),mazeCtx.beginPath(),mazeCtx.arc(t.x,t.y,t.radius,0,2*Math.PI),mazeCtx.fillStyle=`rgba(225, 239, 255, ${t.opacity})`,mazeCtx.fill();mazeCtx.restore(),state.defeatAnimation.progress>=1&&(state.playerIsDefeated=!1,state.isTimerDefeat=!1,restartLevel())}
        function drawIntroAnimation(){const e=-Math.abs(Math.sin(.005*Date.now())*(.15*cellSize));mazeCtx.save(),mazeCtx.translate(displayPos.x,displayPos.y+e),mazeCtx.textAlign="center",mazeCtx.textBaseline="middle",mazeCtx.font=`bold ${Math.floor(.7*cellSize)}px sans-serif`,mazeCtx.fillText(currentTheme.player,0,0+.05*cellSize),mazeCtx.restore(),mazeCtx.save(),mazeCtx.translate(state.finishPos.x*cellSize+cellSize/2,state.finishPos.y*cellSize+cellSize/2+e),mazeCtx.font=`bold ${Math.floor(.8*cellSize)}px sans-serif`,mazeCtx.textAlign="center",mazeCtx.textBaseline="middle",mazeCtx.fillText(currentTheme.finish,0,0+.05*cellSize),mazeCtx.restore()}
        function gameLoop(){if("game-screen"!==state.currentScreen)return;animationFrameId=requestAnimationFrame(gameLoop),state.playerIsDefeated||(displayPos.x+=(targetPos.x-displayPos.x)*ANIMATION_SPEED,displayPos.y+=(targetPos.y-displayPos.y)*ANIMATION_SPEED,Math.abs(targetPos.x-displayPos.x)<.5&&Math.abs(targetPos.y-displayPos.y)<.5&&(displayPos.x=targetPos.x,displayPos.y=targetPos.y,state.isAnimating&&(state.isAnimating=!1,checkCollision(),state.isMoving||checkWin()))),state.ghosts.forEach(e=>{e.displayPos.x+=(e.targetPos.x-e.displayPos.x)*ANIMATION_SPEED,e.displayPos.y+=(e.targetPos.y-e.displayPos.y)*ANIMATION_SPEED}),state.minotaurs.forEach(e=>{e.displayPos.x+=(e.targetPos.x-e.displayPos.x)*ANIMATION_SPEED,e.displayPos.y+=(e.targetPos.y-e.displayPos.y)*ANIMATION_SPEED}),mazeCtx.clearRect(0,0,dom.mazeCanvas.width,dom.mazeCanvas.height);const gradient=mazeCtx.createLinearGradient(0,0,0,dom.mazeCanvas.height);gradient.addColorStop(0,currentTheme.gradient[0]),gradient.addColorStop(1,currentTheme.gradient[1]),mazeCtx.fillStyle=gradient,mazeCtx.fillRect(0,0,dom.mazeCanvas.width,dom.mazeCanvas.height),currentBgImage&&currentBgImage.complete&&(mazeCtx.save(),mazeCtx.globalAlpha=.35,mazeCtx.drawImage(currentBgImage,0,0,currentBgImage.width,currentBgImage.height,0,0,dom.mazeCanvas.width,dom.mazeCanvas.height),mazeCtx.restore()),drawWalls(),drawDecor(),drawHintIndicator(),state.isIntroAnimationActive?drawIntroAnimation():(drawFinish(),drawGhosts(),drawMinotaurs(),state.playerIsDefeated?drawPlayerDefeatAnimation():(drawPlayer(),state.isMoving||state.hint.visible||drawMoveIndicators()),state.isGameActive&&(["flashlight","all-in-one","minotaur"].includes(state.gameMode))&&(lightRadius=(getActiveLevelsConfig()[state.currentLevel].visibility.w+getActiveLevelsConfig()[state.currentLevel].visibility.h)/2*cellSize,mazeCtx.save(),mazeCtx.fillStyle="black",mazeCtx.beginPath(),mazeCtx.rect(0,0,dom.mazeCanvas.width,dom.mazeCanvas.height),mazeCtx.arc(displayPos.x,displayPos.y,lightRadius,0,2*Math.PI,!0),mazeCtx.fill("evenodd"),mazeCtx.restore()))}
        function stopGameLoop(){animationFrameId&&(cancelAnimationFrame(animationFrameId),animationFrameId=null)}
        function updateDecorCounter(){const e=document.getElementById("decor-counter");state.totalDecor>0&&currentTheme.decor.length>0?(e.style.display="flex",e.innerHTML=`${currentTheme.decor[0]||"⭐"}&nbsp;${state.collectedDecor}&nbsp;/&nbsp;${state.totalDecor}`):e.style.display="none"}
        function handleTimerDefeat(){state.isGameActive=!1,state.isTimerDefeat=!0,state.playerIsDefeated=!0,stopPlayerMove(),stopGhostAI(),stopMinotaurAI(),audioManager.stopWarningSfx(),audioManager.playSfx(config.audio.timerDefeatSfx),state.defeatAnimation.progress=0,state.defeatAnimation.bubbles=[];for(let e=0;e<15;e++)state.defeatAnimation.bubbles.push({x:.5*(Math.random()-.5)*cellSize,y:.5*(Math.random()-.5)*cellSize,radius:5*Math.random(),maxRadius:15*Math.random()+10,speed:.5*Math.random()+.5})}
        function updateTimerDisplay(){dom.timerDisplay&&(state.gameTimer.timeLeft<=0?dom.timerDisplay.innerHTML='⏰ <span style="color: var(--primary-pink);">00</span>':(dom.timerDisplay.innerHTML=`⏰ ${state.gameTimer.timeLeft.toString().padStart(2,"0")}`,state.gameTimer.timeLeft<=20?dom.timerDisplay.classList.contains("warning")||(dom.timerDisplay.classList.add("warning"),audioManager.playWarningSfx(config.audio.timerWarningSfx)):(dom.timerDisplay.classList.remove("warning"),audioManager.stopWarningSfx())))}
        function countdown(){state.isGameActive?(state.gameTimer.timeLeft--,updateTimerDisplay(),state.gameTimer.timeLeft<=0&&(clearInterval(state.gameTimer.id),state.gameTimer.id=null,handleTimerDefeat())):(clearInterval(state.gameTimer.id),state.gameTimer.id=null)}
        function restartLevel(){if(!initialMazeGrid)return;hideModal(dom.victoryModal),hideModal(dom.tvBackModal),stopGame(),mazeGrid=JSON.parse(JSON.stringify(initialMazeGrid)),state.playerPos={...state.startPos},targetPos.x=displayPos.x=state.playerPos.x*cellSize+cellSize/2,targetPos.y=displayPos.y=state.playerPos.y*cellSize+cellSize/2;["ghost","all-in-one"].includes(state.gameMode)&&state.ghosts.forEach((e,t)=>{const a=state.startGhosts[t];e.x=a.x,e.y=a.y,e.displayPos={x:a.x*cellSize+cellSize/2,y:a.y*cellSize+cellSize/2},e.targetPos={...e.displayPos},e.isIndicating=!1,e.nextMove=null,e.pathIndex=0}),"minotaur"===state.gameMode&&state.minotaurs.forEach((e,t)=>{const a=state.startMinotaurs[t];e.x=a.x,e.y=a.y,e.displayPos={x:a.x*cellSize+cellSize/2,y:a.y*cellSize+cellSize/2},e.targetPos={...e.displayPos}}),state.collectedDecor=0,state.playerIsDefeated=!1,state.isTimerDefeat=!1,state.isIntroAnimationActive=!1,state.defeatAnimation={progress:0,bubbles:[]},state.hint={nextStep:null,visible:!1,timer:null},dom.timerDisplay.classList.remove("warning"),updateDecorCounter(),state.isGameActive=!0,["timer","all-in-one","minotaur"].includes(state.gameMode)&&(dom.timerDisplay.style.display="flex",state.gameTimer.timeLeft=getActiveLevelsConfig()[state.currentLevel].timer,updateTimerDisplay(),state.gameTimer.id=setInterval(countdown,1e3)),startGhostAI(),startMinotaurAI(),gameLoop()}
        function step(){if(!state.isMoving)return void clearInterval(playerMoveInterval);const{x:e,y:t}=state.playerPos,a=mazeGrid[t][e];let o=!1;if("up"===state.playerMoveDirection&&!a.walls.top?o=!0:"down"===state.playerMoveDirection&&!a.walls.bottom?o=!0:"left"===state.playerMoveDirection&&!a.walls.left?o=!0:"right"===state.playerMoveDirection&&!a.walls.right&&(o=!0),!o)return void stopPlayerMove();let n=e,s=t;"up"===state.playerMoveDirection?s--:"down"===state.playerMoveDirection?s++:"left"===state.playerMoveDirection?n--:"right"===state.playerMoveDirection&&n++;state.isAnimating=!0,state.playerPos={x:n,y:s},targetPos.x=n*cellSize+cellSize/2,targetPos.y=s*cellSize+cellSize/2,checkCollision();if(state.playerIsDefeated)return void stopPlayerMove();const i=mazeGrid[s][n];if(i.decor&&(state.collectedDecor++,updateDecorCounter(),audioManager.playSfx(config.audio.collectSfx),i.decor=null),4-Object.values(i.walls).filter(Boolean).length!==2||n===state.finishPos.x&&s===state.finishPos.y)stopPlayerMove()}
        function initiatePlayerMove(e){
            if (state.isIntroAnimationActive) {
                beginGameplay();
                setTimeout(() => initiatePlayerMove(e), 50);
                return;
            }
            if (!state.isGameActive || state.playerIsDefeated || state.isAnimating) {
                return;
            }
            if (state.isMoving) return;
            const {x: t, y: a} = state.playerPos;
            const o = mazeGrid[a][t];
            let n = false;
            switch (e) {
                case "up": if (!o.walls.top) n = true; break;
                case "down": if (!o.walls.bottom) n = true; break;
                case "left": if (!o.walls.left) n = true; break;
                case "right": if (!o.walls.right) n = true; break;
            }
            if (!n) return;
            hideHint();
            state.isMoving = true;
            state.playerMoveDirection = e;
            step();
            if (state.isMoving) {
                playerMoveInterval = setInterval(step, 160);
            }
        }
        function handleGameInput(e){if(state.isIntroAnimationActive)return beginGameplay(),void setTimeout(()=>handleGameInput(e),0);let t=null;"ArrowUp"===e||"w"===e?t="up":"ArrowDown"===e||"s"===e?t="down":"ArrowLeft"===e||"a"===e?t="left":"ArrowRight"!==e&&"d"!==e||(t="right"),t&&initiatePlayerMove(t)}
        function startGhostAI(){stopGhostAI();if(!["ghost","all-in-one"].includes(state.gameMode))return;state.ghosts.forEach(e=>{const t=()=>{if(!state.isGameActive||state.isMoving)return void(e.moveTimeout=setTimeout(t,400*Math.random()+800));if(e.isIndicating||!e.path||0===e.path.length)return void(e.moveTimeout=setTimeout(t,400*Math.random()+800));e.pathIndex=(e.pathIndex+1)%e.path.length;e.nextMove=e.path[e.pathIndex];e.isIndicating=!0;e.moveTimeout=setTimeout(()=>{e.nextMove?(e.isIndicating=!1,e.x=e.nextMove.x,e.y=e.nextMove.y,e.targetPos.x=e.x*cellSize+cellSize/2,e.targetPos.y=e.y*cellSize+cellSize/2,e.nextMove=null,checkCollision(),e.moveTimeout=setTimeout(t,400*Math.random()+800)):(e.isIndicating=!1,e.moveTimeout=setTimeout(t,400*Math.random()+800))},500)};e.moveTimeout=setTimeout(t,400*Math.random()+800)})}
        function startMinotaurAI() {stopMinotaurAI();if (state.gameMode !== 'minotaur') return;state.minotaurs.forEach(minotaur => {const move = () => {if (!state.isGameActive) {minotaur.moveTimeout = setTimeout(move, 500 + Math.random() * 500); return;}const { x, y } = minotaur;const possibleMoves = [];const walls = mazeGrid[y][x].walls;if (!walls.top && y > 0) possibleMoves.push({ x, y: y - 1 });if (!walls.bottom && y < state.mazeHeight - 1) possibleMoves.push({ x, y: y + 1 });if (!walls.left && x > 0) possibleMoves.push({ x: x - 1, y });if (!walls.right && x < state.mazeWidth - 1) possibleMoves.push({ x: x + 1, y });if (possibleMoves.length > 0) {const nextMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];minotaur.x = nextMove.x;minotaur.y = nextMove.y;minotaur.targetPos.x = nextMove.x * cellSize + cellSize / 2;minotaur.targetPos.y = nextMove.y * cellSize + cellSize / 2;checkCollision();}minotaur.moveTimeout = setTimeout(move, 500 + Math.random() * 500);};minotaur.moveTimeout = setTimeout(move, 500 + Math.random() * 500);});}
        function checkCollision(){if(state.playerIsDefeated)return;const enemies = [...state.ghosts, ...state.minotaurs]; for(const enemy of enemies){if(state.playerPos.x===enemy.x&&state.playerPos.y===enemy.y){state.isGameActive=!1,state.playerIsDefeated=!0,stopPlayerMove(),stopGhostAI(),stopMinotaurAI(),audioManager.playSfx(config.audio.defeatSfx),state.defeatAnimation.progress=0,state.defeatAnimation.bubbles=[];for(let e=0;e<15;e++)state.defeatAnimation.bubbles.push({x:.5*(Math.random()-.5)*cellSize,y:.5*(Math.random()-.5)*cellSize,radius:5*Math.random(),maxRadius:15*Math.random()+10,speed:.5*Math.random()+.5});return!0}}return!1}
        function resizeCanvas(){if("game-screen"!==state.currentScreen)return;const e=document.getElementById("maze-wrapper");if(!e)return;const t=getActiveLevelsConfig();state.currentLevel>=t.length&&(state.currentLevel=t.length-1);const a=t[state.currentLevel];state.mazeWidth=a.w,state.mazeHeight=a.h;const o=state.mazeWidth/state.mazeHeight,n=e.clientWidth/e.clientHeight;let s,i;n>o?(i=e.clientHeight,s=i*o):(s=e.clientWidth,i=s/o);const l=window.devicePixelRatio||1;dom.mazeCanvas.style.width=`${s}px`,dom.mazeCanvas.style.height=`${i}px`,dom.mazeCanvas.width=Math.floor(s*l),dom.mazeCanvas.height=Math.floor(i*l),mazeCtx.scale(l,l),cellSize=Math.floor(Math.min(s/state.mazeWidth,i/state.mazeHeight)),targetPos.x=displayPos.x=state.playerPos.x*cellSize+cellSize/2,targetPos.y=displayPos.y=state.playerPos.y*cellSize+cellSize/2,state.ghosts.forEach(e=>{e.displayPos.x=e.targetPos.x=e.x*cellSize+cellSize/2,e.displayPos.y=e.targetPos.y=e.y*cellSize+cellSize/2}),state.minotaurs.forEach(e=>{e.displayPos.x=e.targetPos.x=e.x*cellSize+cellSize/2,e.displayPos.y=e.targetPos.y=e.y*cellSize+cellSize/2})}
        function startGame(e) {
            const levels = getActiveLevelsConfig();
            if (!levels || e >= levels.length) {
                console.error("Invalid level configuration for mode:", state.gameMode, "level:", e);
                goToMainMenu();
                return;
            }
            const levelConfig = levels[e];

            switchScreen("game-screen");
            state.currentLevel = e;
            
            state.playerIsDefeated = false;
            state.isTimerDefeat = false;
            state.collectedDecor = 0;
            state.totalDecor = 0;
            state.ghosts = [];
            state.startGhosts = [];
            state.minotaurs = [];
            state.startMinotaurs = [];
            dom.timerDisplay.classList.remove("warning");

            currentTheme = JSON.parse(JSON.stringify(
                state.theme === "random" || !config.themes[state.theme]
                ? config.themes[Object.keys(config.themes)[Math.floor(Math.random() * Object.keys(config.themes).length)]]
                : config.themes[state.theme]
            ));
            
            currentBgImage = loadedBackgroundImages[Math.floor(Math.random() * loadedBackgroundImages.length)];
            state.mazeWidth = levelConfig.w;
            state.mazeHeight = levelConfig.h;
            
            const mazeAlgorithm = levelConfig.mazeAlgorithm || 'recursiveBacktracker';

            if (state.gameMode === "minotaur") {
                currentTheme.finish = e < 4 ? "🪜" : "🏞️";
                currentTheme.decor = ["🪙", "💎"];
                state.finishPos = { x: Math.floor(state.mazeWidth / 2), y: Math.floor(state.mazeHeight / 2) };
                const corners = [{x: 0, y: 0}, {x: state.mazeWidth - 1, y: 0}, {x: 0, y: state.mazeHeight - 1}, {x: state.mazeWidth - 1, y: state.mazeHeight - 1}];
                const possibleStartPos = corners.filter(c => c.x !== state.finishPos.x || c.y !== state.finishPos.y);
                state.startPos = { ...possibleStartPos[Math.floor(Math.random() * possibleStartPos.length)] };
            } else {
                 const corners = [{x: 0, y: 0}, {x: state.mazeWidth - 1, y: 0}, {x: 0, y: state.mazeHeight - 1}, {x: state.mazeWidth - 1, y: state.mazeHeight - 1}];
                state.startPos = { ...corners[Math.floor(Math.random() * corners.length)] };
            }

            mazeGrid = generateMaze(state.mazeWidth, state.mazeHeight, state.startPos, mazeAlgorithm);
            
            if(state.gameMode !== "minotaur") {
                 state.finishPos = findLongestPath(mazeGrid, mazeGrid[state.startPos.y][state.startPos.x]);
            }

            addDecorations(mazeGrid, state.startPos, state.finishPos, levelConfig.bonuses);
            state.playerPos = { ...state.startPos };

            if (state.gameMode === "ghost" || state.gameMode === "all-in-one") {
                for (let i = 0; i < levelConfig.ghosts; i++) {
                    let ghostStartPos;
                    const availablePos = [];
                    for(let y=0; y<state.mazeHeight; y++) {
                        for(let x=0; x<state.mazeWidth; x++) {
                           if(Math.abs(x - state.playerPos.x) > 3 || Math.abs(y - state.playerPos.y) > 3) {
                               availablePos.push({x,y});
                           }
                        }
                    }
                    ghostStartPos = availablePos.length > 0 ? availablePos[Math.floor(Math.random() * availablePos.length)] : { x: Math.floor(Math.random() * state.mazeWidth), y: Math.floor(Math.random() * state.mazeHeight) };
                    
                    let patrolParams = levelConfig.ghostPatrol || { w: 3, h: 3 };
                    let patrolPath = [];
                    if (Math.random() < 0.5) { // Square patrol
                        const halfW = Math.floor((patrolParams.w - 1) / 2);
                        const halfH = Math.floor((patrolParams.h - 1) / 2);
                        const top = Math.max(0, ghostStartPos.y - halfH);
                        const bottom = Math.min(state.mazeHeight - 1, ghostStartPos.y + halfH);
                        const left = Math.max(0, ghostStartPos.x - halfW);
                        const right = Math.min(state.mazeWidth - 1, ghostStartPos.x + halfW);
                        if (left === right && top === bottom) {
                            patrolPath.push({x: left, y: top});
                        } else {
                            for (let i = left; i < right; i++) patrolPath.push({x: i, y: top});
                            for (let i = top; i < bottom; i++) patrolPath.push({x: right, y: i});
                            for (let i = right; i > left; i--) patrolPath.push({x: i, y: bottom});
                            for (let i = bottom; i > top; i--) patrolPath.push({x: left, y: i});
                        }
                    } else { // Cross patrol
                        const halfW = Math.floor((patrolParams.w - 1) / 2);
                        const halfH = Math.floor((patrolParams.h - 1) / 2);
                        const topY = Math.max(0, ghostStartPos.y - halfH);
                        const bottomY = Math.min(state.mazeHeight - 1, ghostStartPos.y + halfH);
                        const leftX = Math.max(0, ghostStartPos.x - halfW);
                        const rightX = Math.min(state.mazeWidth - 1, ghostStartPos.x + halfW);
                        for (let i = ghostStartPos.x + 1; i <= rightX; i++) patrolPath.push({ x: i, y: ghostStartPos.y });
                        for (let i = rightX; i > ghostStartPos.x; i--) patrolPath.push({ x: i, y: ghostStartPos.y });
                        for (let i = ghostStartPos.y + 1; i <= bottomY; i++) patrolPath.push({ x: ghostStartPos.x, y: i });
                        for (let i = bottomY; i > ghostStartPos.y; i--) patrolPath.push({ x: ghostStartPos.x, y: i });
                        for (let i = ghostStartPos.x - 1; i >= leftX; i--) patrolPath.push({ x: i, y: ghostStartPos.y });
                        for (let i = leftX; i < ghostStartPos.x; i++) patrolPath.push({ x: i, y: ghostStartPos.y });
                        for (let i = ghostStartPos.y - 1; i >= topY; i--) patrolPath.push({ x: ghostStartPos.x, y: i });
                        for (let i = topY; i < ghostStartPos.y; i++) patrolPath.push({ x: ghostStartPos.x, y: i });
                    }
                    if (patrolPath.length === 0) patrolPath.push({x: ghostStartPos.x, y: ghostStartPos.y});
                    const ghost = { ...ghostStartPos, displayPos: { x: ghostStartPos.x * cellSize + cellSize / 2, y: ghostStartPos.y * cellSize + cellSize / 2 }, targetPos: { x: ghostStartPos.x * cellSize + cellSize / 2, y: ghostStartPos.y * cellSize + cellSize / 2 }, isIndicating: false, nextMove: null, path: patrolPath, pathIndex: 0, moveTimeout: null };
                    state.ghosts.push(ghost);
                    state.startGhosts.push({ ...ghostStartPos });
                }
            } else if (state.gameMode === "minotaur") {
                for (let i = 0; i < levelConfig.minotaurs; i++) {
                    let minotaurStart = { x: state.finishPos.x, y: state.finishPos.y };
                    const minotaur = { ...minotaurStart, displayPos: { x: minotaurStart.x * cellSize + cellSize / 2, y: minotaurStart.y * cellSize + cellSize / 2 }, targetPos: { x: minotaurStart.x * cellSize + cellSize / 2, y: minotaurStart.y * cellSize + cellSize / 2 }, moveTimeout: null };
                    state.minotaurs.push(minotaur);
                    state.startMinotaurs.push({ ...minotaurStart });
                }
            }

            if (["timer", "all-in-one", "minotaur"].includes(state.gameMode)) {
                dom.timerDisplay.style.display = "flex";
                state.gameTimer.timeLeft = levelConfig.timer;
                updateTimerDisplay();
                state.gameTimer.id = setInterval(countdown, 1000);
            } else {
                dom.timerDisplay.style.display = "none";
            }
            initialMazeGrid = JSON.parse(JSON.stringify(mazeGrid));
            updateDecorCounter();
            setTimeout(() => {
                resizeCanvas();
                stopGameLoop();
                startIntroPhase();
            }, 50);
        }
        function showHint(){if(state.hint.visible)return;const e=findSolutionPath(mazeGrid,state.playerPos,state.finishPos);e.length>1&&(state.hint.nextStep=e[1],state.hint.visible=!0,state.hint.timer&&clearTimeout(state.hint.timer),state.hint.timer=setTimeout(()=>hideHint(),2e3))}
        function startIntroPhase(){state.isGameActive=!1,state.isIntroAnimationActive=!0,["timer","all-in-one","minotaur"].includes(state.gameMode)&&(dom.timerDisplay.style.display="flex"),gameLoop()}
        function beginGameplay(){state.isIntroAnimationActive&&(state.isIntroAnimationActive=!1,state.dpadNavActive=!0,state.isGameActive=!0,["timer","all-in-one","minotaur"].includes(state.gameMode)&&!state.gameTimer.id&&(state.gameTimer.id=setInterval(countdown,1e3)),startGhostAI(),startMinotaurAI())}
        function launchConfetti(){const e=document.querySelector("#victory-modal .animation-container");e.innerHTML="";for(let t=0;t<50;t++){const a=document.createElement("div");a.classList.add("confetti"),a.style.left=`${100*Math.random()}%`,a.style.backgroundColor=`hsl(${360*Math.random()}, 100%, 70%)`,a.style.animationDelay=`${.5*Math.random()}s`,a.style.animationDuration=`${2*Math.random()+2}s`,e.appendChild(a)}}
        function showMinotaurVictoryAnimation() {
            audioManager.stop();
            audioManager.play('https://lkalyadin.github.io/emojie_maze/assets/audio/sfx-piano-bar.mp3');
            document.getElementById('minotaur-victory-player').textContent = currentTheme.player;
            showModal(dom.minotaurVictoryModal);
            setTimeout(() => {
                hideModal(dom.minotaurVictoryModal);
                audioManager.stop();
                let stars = 1;
                stars = state.collectedDecor === state.totalDecor ? 3 : (state.collectedDecor >= Math.ceil(state.totalDecor / 2) ? 2 : 1);
                if (stars > (state.progress[state.gameMode]?.[state.currentLevel] || 0)) {
                    state.progress[state.gameMode][state.currentLevel] = stars;
                    saveProgress();
                    updateTotalStarsCounter();
                }
                const starContainer = document.getElementById("star-rating-container");
                starContainer.innerHTML = "";
                for (let i = 1; i <= 3; i++) {
                    const starEl = document.createElement("span");
                    starEl.textContent = "★";
                    starEl.className = i <= stars ? "star yellow" : "star gray";
                    starContainer.appendChild(starEl);
                }
                if (getActiveLevelsConfig().length - 1 > state.currentLevel) {
                    document.getElementById("next-level-button").style.display = "flex";
                } else {
                    document.getElementById("next-level-button").style.display = "none";
                }
                showModal(dom.victoryModal);
                audioManager.playSfx(config.audio.victorySfx[Math.floor(Math.random() * config.audio.victorySfx.length)]);
                launchConfetti();
            }, 7000);
        }
        function checkWin(){if(isStoppingGame||!state.isGameActive)return!1;if(state.playerPos.x===state.finishPos.x&&state.playerPos.y===state.finishPos.y){state.isGameActive=!1;setTimeout(()=>{stopGame();if(state.gameMode==="minotaur"&&state.currentLevel===4){showMinotaurVictoryAnimation()}else{let e=1;state.totalDecor>0?e=state.collectedDecor===state.totalDecor?3:state.collectedDecor>=Math.ceil(state.totalDecor/2)?2:1:e=3,e>(state.progress[state.gameMode]?.[state.currentLevel]||0)&&(state.progress[state.gameMode][state.currentLevel]=e,saveProgress(),updateTotalStarsCounter());const t=document.getElementById("star-rating-container");t.innerHTML="";for(let a=1;a<=3;a++){const o=document.createElement("span");o.textContent="★",o.className=a<=e?"star yellow":"star gray",t.appendChild(o)}getActiveLevelsConfig().length-1>state.currentLevel?document.getElementById("next-level-button").style.display="flex":document.getElementById("next-level-button").style.display="none",showModal(dom.victoryModal),audioManager.playSfx(config.audio.victorySfx[Math.floor(Math.random()*config.audio.victorySfx.length)]),launchConfetti()}},300);return!0}return!1}
        function showLevelSelectionScreen(e){state.gameMode=e;const t=document.getElementById("level-selection-grid");t.innerHTML="";const a=getActiveLevelsConfig();a.forEach((o,n)=>{const s=document.createElement("button");s.className="level-card nav-item",s.dataset.navIndex=n+1;const i=state.progress[e]?.[n]||0;let l="";for(let e=0;e<3;e++)l+=`<span class="star ${e<i?"filled":""}">★</span>`;s.innerHTML=`\n <div class="level-number">${n+1}</div>\n <div class="level-stars">${l}</div>\n `,s.addEventListener("click",()=>startGame(n)),t.appendChild(s)}),switchScreen("level-selection-screen")}
        function showModal(e){const t=[dom.confirmResetModal,dom.confirmExitModal,dom.victoryModal,dom.aboutModal].includes(e);state.dpadNavActive=!t,state.modalNavIndex=0,e.classList.add("visible");const a=Array.from(e.querySelectorAll(".modal-button"));state.dpadNavActive?a.forEach((e,t)=>e.classList.toggle("selected",0===t)):a.forEach(e=>e.classList.remove("selected"))}
        function hideModal(e){e.classList.remove("visible");Array.from(e.querySelectorAll(".modal-button")).forEach(e=>e.classList.remove("selected")),setupNavigation()}
        function setLanguage(e){state.settings.language=e,document.documentElement.lang=e,document.querySelectorAll("[data-lang]").forEach(t=>{const a=t.dataset.lang;if(config.languages[e]&&config.languages[e][a]){const o=t.querySelector("span:not(.card-icon)")||t;o&&(o.textContent=config.languages[e][a])}});const t=document.querySelector("#language-button .lang-text");t&&(t.textContent=config.languageNames[e]||e.toUpperCase()),document.querySelectorAll(".theme-name").forEach(t=>{const a=t.parentElement.dataset.themeKey;config.languages[e]&&config.languages[e][a]&&(t.textContent=config.languages[e][a])});const a=document.querySelector("#loading-screen p");a&&(a.textContent="")}
        function applyColorTheme(){document.body.classList.toggle('light-theme',state.settings.colorTheme==='light'),updateThemeButtonUI()}
        function updateThemeButtonUI(){const e=document.getElementById('theme-toggle-button');if(e){const t=e.querySelector('.card-icon');t&&(t.textContent=state.settings.colorTheme==='light'?'☀️':'🌙')}}
        function updateSoundButtonUI(){const e=document.getElementById('sound-toggle-button');if(e){const t=e.querySelector('.card-icon');t&&(t.textContent=state.settings.sound?'🔊':'🔇')}}
        function updateDpadButtonUI(){const e=document.getElementById('dpad-toggle-button');if(e){const t=e.querySelector('.dpad-status');t&&(t.textContent=state.settings.dpad?'✔️':'❌')}}
        function updateModeCompletionPercentage(){const e=getActiveLevelsConfig(); for(const a of["classic","flashlight","ghost","timer","minotaur","all-in-one"]){const o=document.getElementById(`mode-${a}`);if(o){const n=o.querySelector(".mode-percentage");if(n){const s=a==="minotaur"?5:e.length,i=3*s,l=Object.values(state.progress[a]||{}).reduce((e,t)=>e+t,0);n.textContent=`${i>0?Math.round(l/i*100):0}%`}}}}
        function handleCanvasClick(e){if(state.isIntroAnimationActive)return void beginGameplay();if(state.isMoving||!state.isGameActive||state.playerIsDefeated)return;const t=dom.mazeCanvas.getBoundingClientRect(),a=(e.clientX-t.left)/(dom.mazeCanvas.width/t.width),o=(e.clientY-t.top)/(dom.mazeCanvas.height/t.height),n=a-(state.playerPos.x*cellSize+cellSize/2),s=o-(state.playerPos.y*cellSize+cellSize/2);initiatePlayerMove(Math.abs(n)>Math.abs(s)?n>0?"right":"left":s>0?"down":"up")}
        function handlePageVisibility(){document.hidden?(state.gameTimer.id&&(clearInterval(state.gameTimer.id),state.gameTimer.isPaused=!0),audioManager.musicWasPlaying=audioManager.currentTrack&&!audioManager.currentTrack.paused,audioManager.currentTrack?.pause(),audioManager.warningSfx?.pause()):(audioManager.musicWasPlaying&&audioManager.currentTrack?.play().catch(e=>{}),state.gameTimer.isPaused&&(state.gameTimer.isPaused=!1,state.isGameActive&&["timer","all-in-one","minotaur"].includes(state.gameMode)&&state.gameTimer.timeLeft>0&&(state.gameTimer.timeLeft<=20&&audioManager.playWarningSfx(config.audio.timerWarningSfx),state.gameTimer.id=setInterval(countdown,1e3))))}
        async function preloadAssets(){const e=config.backgrounds.map(e=>new Promise(t=>{const a=new Image;a.onload=()=>t(a),a.onerror=()=>{console.warn(`Failed to load image: ${e}`),t(null)},a.crossOrigin="Anonymous",a.src=e}));loadedBackgroundImages.push(...(await Promise.all(e)).filter(e=>null!==e)),setTimeout(goToMainMenu,500)}
        function initialize(){
            loadProgress(),loadSettings(),applyColorTheme(),updateTotalStarsCounter(),updateModeCompletionPercentage(),updateSoundButtonUI(),updateDpadButtonUI();
            const userLang = state.settings.language || navigator.language.slice(0, 2);
            const defaultLang = config.languages[userLang] ? userLang : 'ru';
            const themesPanel = document.querySelector('#themes-screen .menu-panel');
            let themeNavIndex = 2;
            for(const key in config.themes){const theme=config.themes[key],item=document.createElement('button');item.className='menu-button nav-item',item.dataset.themeKey=key,item.dataset.navIndex=themeNavIndex++,item.innerHTML=`<span>${theme.player}</span>`;const themeNameSpan=document.createElement('span');themeNameSpan.className='theme-name',themeNameSpan.dataset.lang=key,item.appendChild(themeNameSpan),item.insertAdjacentHTML('beforeend',`<span>${theme.finish}</span>`),item.addEventListener('click',()=>{state.theme=key,updateEmojiBackground(),switchScreen('main-menu-screen')}),themesPanel.appendChild(item)}
            setLanguage(defaultLang);
            currentTheme = "random"===state.theme||!config.themes[state.theme]?config.themes[Object.keys(config.themes)[Math.floor(Math.random()*Object.keys(config.themes).length)]]:config.themes[state.theme];
            updateEmojiBackground();
            document.addEventListener('visibilitychange',handlePageVisibility);
            document.addEventListener('keydown',handleGlobalKeyDown);
            let resizeTimeout;window.addEventListener('resize',()=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{'game-screen'===state.currentScreen&&resizeCanvas(),'level-selection-screen'===state.currentScreen&&showLevelSelectionScreen(state.gameMode),setupNavigation()},100)});
            const addEvt=(id,evt,fn)=>document.getElementById(id).addEventListener(evt,fn);
            addEvt('play-button','click',()=>switchScreen('game-mode-screen'));
            addEvt('mode-classic','click',()=>showLevelSelectionScreen('classic'));
            addEvt('mode-flashlight','click',()=>showLevelSelectionScreen('flashlight'));
            addEvt('mode-ghost','click',()=>showLevelSelectionScreen('ghost'));
            addEvt('mode-timer','click',()=>showLevelSelectionScreen('timer'));
            addEvt('mode-minotaur','click',()=>showLevelSelectionScreen('minotaur'));
            addEvt('mode-all-in-one','click',()=>showLevelSelectionScreen('all-in-one'));
            addEvt('mode-random','click',()=>{
                const modes = ['classic','flashlight','ghost','timer','all-in-one'];
                state.gameMode = modes[Math.floor(Math.random() * modes.length)];
                const levels = getActiveLevelsConfig();
                startGame(Math.floor(Math.random() * levels.length));
            });
            addEvt('settings-button','click',()=>switchScreen('settings-screen'));
            addEvt('themes-button','click',()=>switchScreen('themes-screen'));
            addEvt('about-button','click',()=>showModal(dom.aboutModal));
            document.querySelectorAll('.back-button').forEach(e=>e.addEventListener('click',()=>switchScreen(e.dataset.targetScreen)));
            addEvt('return-menu-button','click',()=>{showModal(dom.confirmExitModal),state.isGameActive=!1,stopGhostAI(),stopMinotaurAI()});
            addEvt('hint-button','click',showHint);
            addEvt('restart-game-button','click',restartLevel);
            addEvt('menu-button-victory','click',()=>{hideModal(dom.victoryModal),showLevelSelectionScreen(state.gameMode)});
            addEvt('next-level-button','click',()=>{hideModal(dom.victoryModal),startGame(state.currentLevel+1)});
            addEvt('retry-level-button-victory','click',restartLevel);
            addEvt('confirm-exit-yes','click',()=>{hideModal(dom.confirmExitModal),stopGame(),showLevelSelectionScreen(state.gameMode)});
            addEvt('confirm-exit-no','click',()=>{hideModal(dom.confirmExitModal),state.playerIsDefeated||(state.isGameActive=!0,startGhostAI(),startMinotaurAI())});
            addEvt('reset-progress-button','click',()=>showModal(dom.confirmResetModal));
            addEvt('confirm-reset-yes','click',()=>{hideModal(dom.confirmResetModal),resetProgress()});
            addEvt('confirm-reset-no','click',()=>hideModal(dom.confirmResetModal));
            addEvt('tv-back-home','click',()=>{hideModal(dom.tvBackModal),stopGame(),switchScreen('main-menu-screen')});
            addEvt('tv-back-restart','click',restartLevel);
            addEvt('tv-back-hint','click',()=>{hideModal(dom.tvBackModal),showHint(),state.isGameActive=!0});
            addEvt('tv-back-cancel','click',()=>{hideModal(dom.tvBackModal),state.playerIsDefeated||(state.isGameActive=!0,startGhostAI(),startMinotaurAI())});
            addEvt('about-modal-close','click',()=>hideModal(dom.aboutModal));
            addEvt('random-theme-button','click',()=>{state.theme='random',updateEmojiBackground(),switchScreen('main-menu-screen')});
            addEvt('dpad-toggle-button','click',()=>{state.settings.dpad=!state.settings.dpad,updateDpadButtonUI(),saveSettings()});
            addEvt('sound-toggle-button','click',()=>{state.settings.sound=!state.settings.sound,state.settings.sound?'game-screen'!==state.currentScreen&&audioManager.play(config.audio.menu,!0):(audioManager.stop(),audioManager.stopWarningSfx()),updateSoundButtonUI(),saveSettings()});
            addEvt('theme-toggle-button','click',()=>{state.settings.colorTheme='light'===state.settings.colorTheme?'dark':'light',applyColorTheme(),saveSettings()});
            addEvt('language-button','click',()=>{const e=Object.keys(config.languages);setLanguage(e[(e.indexOf(state.settings.language)+1)%e.length])});
            const dpadButtons={'dpad-up':'up','dpad-down':'down','dpad-left':'left','dpad-right':'right'};
            for(const[btnId,direction]of Object.entries(dpadButtons)){const button=document.getElementById(btnId),dpadPress=e=>{e.preventDefault(),state.isIntroAnimationActive?(beginGameplay(),setTimeout(()=>initiatePlayerMove(direction),0)):initiatePlayerMove(direction)};button.addEventListener('mousedown',dpadPress),button.addEventListener('touchstart',dpadPress,{passive:!1})}
            let touchStartX=0,touchStartY=0;
            const handleSwipe=e=>{const t=e.changedTouches[0].screenX-touchStartX,a=e.changedTouches[0].screenY-touchStartY;if(state.isIntroAnimationActive)return void beginGameplay();(Math.abs(t)>30||Math.abs(a)>30)&&initiatePlayerMove(Math.abs(t)>Math.abs(a)?t>0?"right":"left":a>0?"down":"up")};
            dom.mazeCanvas.addEventListener('touchstart',e=>{e.preventDefault(),touchStartX=e.changedTouches[0].screenX,touchStartY=e.changedTouches[0].screenY},{passive:!1});
            dom.mazeCanvas.addEventListener('touchend',e=>{e.preventDefault(),handleSwipe(e)},{passive:!1});
            addEvt('maze-canvas','click',handleCanvasClick);
            preloadAssets();
            switchScreen('loading-screen');
        }
        initialize();
    });
    </script>
</body>
</html>
